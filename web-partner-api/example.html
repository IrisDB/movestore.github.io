<!DOCTYPE html>
<html>

<head>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta charset="UTF-8">
    <title>MoveApps Web-Partner API example</title>
    <link rel=“stylesheet” href=“https://cdn.jsdelivr.net/gh/jgthms/minireset.css@master/minireset.min.css“>
    <style>
        body {
            font-family: sans-serif;
        }
    </style>
</head>

<body>
    <h1>API for analysis output files functional</h1>
    <p>Try out integrating files that you have produced with a MoveApps workflow into your own personal webpage! They are then automatically updated when scheduling workflow runs.</p>

    <section>
        <p>The resources provided by the API are protected. You can provide the credentials by a) Basic access authentication or b) API key.</p>
        <p>
            Keep in mind that the tokens and/or API-Keys will be visible to the public. 
            That is okay for workflows which generate public resources (aka artifacts).
        </p>
        <p>
            If your workflow produces sensitive resources consider consuming the artifacts by a own backend system in order to hide this token from the public.
        </p>
        <table>
            <tr>
                <th>Basic Auth</th>
                <td><code>8b536ed8-a681-4786-aa01-b26040106f9f</code>:<code id="apiToken"></code></td>
            </th>
            <tr>
                <th>API key (URL encoded!)</th>
                <td><code id="apiTokenUrlEncoded"></code></td>
            </tr>
            <caption>The credentials for this example page. You need to register your own ones at MoveApps.</caption>
        </table>
    </section>

    <section>
        <h2>Just a basic list of links</h2>
        <ul>
            <!-- keep in mind that this api-keys will be visible to the public -->
            <li><a href="http://localhost:8080/web-partner/v1/workflowInstances/d8fcb45e-412d-4002-81d6-0fcbdbd5fa5d/apps/1/results/UD_ContourMap_per_Indv_contours_0.5_0.9.pdf?api-key=LAmUg81mhcgNG48nzRzsyWv7r7W0YOSy">some PDF document</a></li>
            <li><a href="http://localhost:8080/web-partner/v1/workflowInstances/d8fcb45e-412d-4002-81d6-0fcbdbd5fa5d/apps/1/results/UD_contour%3A0.5_0.9.zip?api-key=LAmUg81mhcgNG48nzRzsyWv7r7W0YOSy">some ZIP file</a></li>
        </ul>
    </section>

    <section>
        <h2>Embed content via HTML tags</h2>
        <ul>
            <li>Pro: easy - no code</li>
            <li>Con: no metadata (like file was <code>modifiedAt</code>) accessible</li>
            <li>Con: not that dynamic - you cannot dynamically react to changes done in the workflow (like dynamic file names)</li>
        </ul>

        <!-- keep in mind that this api-keys will be visible to the public -->
        <img 
            src="http://localhost:8080/web-partner/v1/workflowInstances/d8fcb45e-412d-4002-81d6-0fcbdbd5fa5d/apps/1/results/UD_ContourMap_color_both_contours_0.5_0.9.png?api-key=LAmUg81mhcgNG48nzRzsyWv7r7W0YOSy"
            height="400px"
        />
        <!-- keep in mind that this api-keys will be visible to the public -->
        <object 
            data="http://localhost:8080/web-partner/v1/workflowInstances/d8fcb45e-412d-4002-81d6-0fcbdbd5fa5d/apps/1/results/UD_ContourMap_per_Indv_contours_0.5_0.9.pdf?api-key=LAmUg81mhcgNG48nzRzsyWv7r7W0YOSy"
            type="application/pdf"
            width="100%"
            height="600px"
        ></object>
    </section>
    <section>
        <h2>Integrate content via JavaScript</h2>
        <ul>
            <li>Pro: use metadata (like <code>modifiedAt</code>)</li>
            <li>Pro: react to changes in the workflow</li>
            <li>Con: Scripting must be enabled</li>
        </ul>

        <p>See here a generated Morning Report PDF</p>
        <object 
            id="pdfElement"
            type="application/pdf"
            width="100%"
            height="600px"
        ></object>
        <div id="pdfModifiedAt"></div>

        <p>See here tracks of our favorite Max Planck species: White storks that were born in Radolfzell moving during the past 12 weeks, updated every morning to integrate new location data transmitted by the tags to Movebank and MoveApps.</p>
        <video width="400" controls loop id="videoElement">
            Your browser does not support the video tag.
        </video>
        <div id="videoModifiedAt"></div>
    </section>
    <script>
        // The MoveApps Web-Partner-API credentials provided by the "output" section of the workflow:
        let username = '8b536ed8-a681-4786-aa01-b26040106f9f'
        // Keep in mind that this token will be visible to the public. That is okay for workflows which generate public resources (aka artifacts).
        // If your workflow produces sensitive resources consider consuming the artifacts by a own backend system in order to hide this token from the public.
        let token = 'bdl@2nq@9SD!i31a1M7HxG7GQG93IQ0a'
        document.getElementById('apiToken').innerHTML = token
        document.getElementById('apiTokenUrlEncoded').innerHTML = encodeURI(document.getElementById('apiToken').innerHTML)
        
        // fetch the `/artifacts/index` endpoint in order to get some metadata
        fetch(
            `https://www.moveapps.org/web-partner/v1/workflowInstances/${username}/artifacts/index`,
            {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa(username + ":" + token),
                    'Accept': 'application/json' // supported response content types are `application/json` and `application/xml`
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('success!', data);
                // a video
                let animationArtifact = data.results[3]
                if (animationArtifact.fileName.endsWith('mp4')) {
                    handleVideo(animationArtifact.links.self, animationArtifact.modifiedAt)
                } else {
                    throw Error('selected artifact is not the expected one! has the workflow- / output-configuration changed?', animationArtifact)
                }
                // a pdf
                let pdfArtifact = data.results[5]
                if (pdfArtifact.fileName.endsWith('pdf')) {
                    handlePdf(pdfArtifact.links.self, pdfArtifact.modifiedAt)
                } else {
                    throw Error('selected artifact is not the expected one! has the workflow- / output-configuration changed?', pdfArtifact)
                }
            })
            .catch(err => console.warn('Something went wrong.', err))

        function handleVideo(src, modifiedAt) {
            // show the timestamp
            document.getElementById('videoModifiedAt').innerHTML = `Modified at ${modifiedAt}`
            // chrome does not allow URLs containing username:password@host 
            // https://bugs.chromium.org/p/chromium/issues/detail?id=82250#c7
            // https://chromestatus.com/feature/5669008342777856
            // so we fetch the video content and feed it into the html video element
            fetch(
                src, 
                { 
                    method: 'GET',
                    headers: {'Authorization': 'Basic ' + btoa(username + ":" + token)}
                }
            )
            // convert response to blob
            .then(response => response.blob())
            // set blob as html source
            .then(blob => document.getElementById('videoElement').src = URL.createObjectURL(blob))
        }

        function handlePdf(src, modifiedAt) {
            // show the timestamp
            document.getElementById('pdfModifiedAt').innerHTML = `Modified at ${modifiedAt}`
            fetch(
                src, 
                { 
                    method: 'GET',
                    headers: {'Authorization': 'Basic ' + btoa(username + ":" + token)}
                }
            )
            // convert response to blob
            .then(response => response.blob())
            // set blob as html source
            .then(blob => document.getElementById('pdfElement').data = URL.createObjectURL(blob))
        }
    </script>
</body>